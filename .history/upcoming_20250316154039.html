<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upcoming Alarms</title>
</head>
<body>
    <h2>Upcoming Medicine Reminder</h2>
    <div id="upcoming-alarm">
        <h3 id="medicine-name">No upcoming alarm</h3>
        <p>Time: <span id="alarm-time"></span></p>
        <img id="medicine-image" src="" alt="Medicine Image" style="max-width:200px; display:none;">
        <audio id="alarm-sound" src="alarm.mp3" preload="auto"></audio>
        <button id="stop-alarm" style="display:none;" onclick="stopAlarm()">Stop Alarm</button>
    </div>

    <script>
        let alarmTriggered = false; 

        function fetchUpcomingAlarm() {
            fetch('/get_upcoming_alarms')
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    let alarm = data[0];  // Get the next upcoming alarm
                    let currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    document.getElementById("medicine-name").innerText = alarm.medicine;
                    document.getElementById("alarm-time").innerText = alarm.time;
                    document.getElementById("medicine-image").src = alarm.image;
                    document.getElementById("medicine-image").style.display = "block";

                    // If it's time for the alarm and it hasn't been triggered yet
                    if (alarm.time === currentTime && !alarmTriggered) {
                        playAlarm();
                        alarmTriggered = true; // Prevent multiple triggers
                    }
                } else {
                    document.getElementById("medicine-name").innerText = "No upcoming alarms";
                    document.getElementById("alarm-time").innerText = "";
                    document.getElementById("medicine-image").style.display = "none";
                }
            });
        }

        function playAlarm() {
            let audio = document.getElementById("alarm-sound");
            audio.play();
            document.getElementById("stop-alarm").style.display = "block";
        }

        function stopAlarm() {
            let audio = document.getElementById("alarm-sound");
            audio.pause();
            audio.currentTime = 0;
            document.getElementById("stop-alarm").style.display = "none";

            // Optional: Mark the alarm as completed in the database
            fetch('/mark_alarm_completed', { method: 'POST' });
        }

        fetchUpcomingAlarm();
        setInterval(fetchUpcomingAlarm, 60000); // Check every minute
    </script>
</body>
</html>
